package search

import (
	"cvepack/core/osv"
	"encoding/json"
	"errors"
	"fmt"
	"strings"
)

type PackageVulnerability struct {
	Id                     int
	VulnerabilityId        string
	PackageEcosystem       string
	PackageName            string
	VersionIntroduced      string
	VersionFixed           *string
	VersionLastAffected    *string
	Summary                string
	Details                string
	Aliases                []byte
	AliasesParsed          []string `json:"Aliases"`
	DatabaseSpecific       []byte
	DatabaseSpecificParsed osv.DatabaseSpecific `json:"DatabaseSpecific"`
}

func (p *PackageVulnerability) Parse() error {
	var aliasesParsed []string
	err := json.Unmarshal([]byte(p.Aliases), &aliasesParsed)
	if err != nil {
		return errors.New(fmt.Sprintf("error parsing aliases: %s", err))
	}
	p.AliasesParsed = aliasesParsed

	var dbSpecParsed osv.DatabaseSpecific
	err = json.Unmarshal(p.DatabaseSpecific, &dbSpecParsed)
	if err != nil {
		return errors.New(fmt.Sprintf("error parsing database specific: %s", err))
	}
	p.DatabaseSpecificParsed = dbSpecParsed

	return nil
}

func (p *PackageVulnerability) String() string {
	return fmt.Sprintf("%s %s %s", p.PackageEcosystem, p.PackageName, p.VersionIntroduced)
}

func (p *PackageVulnerability) AliasesToString() string {
	return strings.Join(p.AliasesParsed, ", ")
}

func (p *PackageVulnerability) SeverityLevel() string {
	return p.DatabaseSpecificParsed.Severity
}

func (p *PackageVulnerability) HasFix() (bool, string) {
	if p.VersionFixed != nil && strings.TrimSpace(*p.VersionFixed) != "" {
		return true, *p.VersionFixed
	}
	return false, ""
}
